networks:
  octo-internal:
    driver: bridge
    ipam:
      config:
          - subnet: 172.21.0.0/16
volumes:
  octo-mongo-data0:
  octo-mongo-data1:
  octo-mongo-data2:
  octo-crate-data1:
  octo-crate-data2:
  octo-crate-data3:

services:
  octo-mongo-2.mongo:
    hostname: octo-mongo-2.mongo
    container_name: octo-mongo-2.mongo
    image: mongo:8.0.12
    command: bash -c "chmod 400 /data/file.key && /usr/bin/mongod --keyFile /data/file.key --replSet rs --bind_ip_all"
    ports:
      - "27018:27017"
    restart: always
    networks:
      - octo-internal
    volumes:
      - "./file.key:/data/file.key"
      - "octo-mongo-data2:/data/db"

  octo-mongo-1.mongo:
    hostname: octo-mongo-1.mongo
    container_name: octo-mongo-1.mongo
    image: mongo:8.0.12
    command: bash -c "chmod 400 /data/file.key && /usr/bin/mongod --keyFile /data/file.key --replSet rs --bind_ip_all"
    ports:
      - "27019:27017"
    restart: always
    networks:
      - octo-internal
    volumes:
      - "./file.key:/data/file.key"
      - "octo-mongo-data1:/data/db"

  octo-mongo-0.mongo:
    hostname: octo-mongo-0.mongo
    container_name: octo-mongo-0.mongo
    image: mongo:8.0.12
    command: bash -c "chmod 400 /data/file.key && /usr/bin/mongod --keyFile /data/file.key --replSet rs --bind_ip_all"
    ports:
      - "27017:27017"
    links:
      - octo-mongo-1.mongo
      - octo-mongo-2.mongo
    restart: always
    networks:
      - octo-internal
    volumes:
      - "./scripts/init-database.js:/scripts/init-database.js"
      - "./scripts/create-admin-user.js:/scripts/create-admin-user.js"
      - "./file.key:/data/file.key"
      - "octo-mongo-data0:/data/db"

  octo-rabbitmq:
    container_name: octo-rabbitmq
    image: rabbitmq:4.0.6-management

    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    networks:
      - octo-internal
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: always
  octo-cratedb01:
    hostname: octo-cratedb01
    container_name: octo-cratedb01
    image: crate:5.10.10
    ports:
      - "4201:4200"
      - "5432:5432"
    volumes:
      - octo-crate-data1:/data
      - ./backup:/mnt/backup
    command:
      [
        "crate",
        "-Ccluster.name=octo-crate-docker-cluster",
        "-Cnode.name=octo-cratedb01",
        "-Cnode.data=true",
        "-Cnetwork.host=_site_",
        "-Cdiscovery.seed_hosts=octo-cratedb02,octo-cratedb03",
        "-Ccluster.initial_master_nodes=octo-cratedb01,octo-cratedb02,octo-cratedb03",
        "-Cgateway.expected_data_nodes=3",
        "-Cgateway.recover_after_data_nodes=2",
        "-Cpath.repo=/mnt/backup",
      ]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    environment:
      - CRATE_HEAP_SIZE=2g

  octo-cratedb02:
    hostname: octo-cratedb02
    container_name: octo-cratedb02
    image: crate:5.10.10
    ports:
      - "4202:4200"
      - "5433:5432"
    volumes:
      - octo-crate-data2:/data
      - ./backup:/mnt/backup
    command:
      [
        "crate",
        "-Ccluster.name=octo-crate-docker-cluster",
        "-Cnode.name=octo-cratedb02",
        "-Cnode.data=true",
        "-Cnetwork.host=_site_",
        "-Cdiscovery.seed_hosts=octo-cratedb01,octo-cratedb03",
        "-Ccluster.initial_master_nodes=octo-cratedb01,octo-cratedb02,octo-cratedb03",
        "-Cgateway.expected_data_nodes=3",
        "-Cgateway.recover_after_data_nodes=2",
        "-Cpath.repo=/mnt/backup",
      ]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    environment:
      - CRATE_HEAP_SIZE=2g

  octo-cratedb03:
    hostname: octo-cratedb03
    container_name: octo-cratedb03
    image: crate:5.10.10
    ports:
      - "4203:4200"
      - "5434:5432"
    volumes:
      - octo-crate-data3:/data
      - ./backup:/mnt/backup
    command:
      [
        "crate",
        "-Ccluster.name=octo-crate-docker-cluster",
        "-Cnode.name=octo-cratedb03",
        "-Cnode.data=true",
        "-Cnetwork.host=_site_",
        "-Cdiscovery.seed_hosts=octo-cratedb01,octo-cratedb02",
        "-Ccluster.initial_master_nodes=octo-cratedb01,octo-cratedb02,octo-cratedb03",
        "-Cgateway.expected_data_nodes=3",
        "-Cgateway.recover_after_data_nodes=2",
      ]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    environment:
      - CRATE_HEAP_SIZE=2g
    
  octo-identity-services:
    hostname: octo-identity-services
    container_name: octo-identity-services
    image: meshmakers/octo-mesh-identity-services:${OCTO_VERSION}
    restart: always    
    environment:
      - OCTO_SYSTEM__AllowInsecureTls=true
      - OCTO_SYSTEM__DATABASEUSERPASSWORD=${USER_PASSWORD}
      - OCTO_SYSTEM__ADMINUSERPASSWORD=${ADMIN_PASSWORD}
      - OCTO_SYSTEM__DATABASEHOST=octo-mongo-0.mongo:27017,octo-mongo-1.mongo:27017,octo-mongo-2.mongo:27017
      - OCTO_IDENTITY__BROKERHOST=octo-rabbitmq
      - OCTO_IDENTITY__BROKERUSER=${RABBITMQ_DEFAULT_USER}
      - OCTO_IDENTITY__BROKERPASSWORD=${RABBITMQ_DEFAULT_PASS}
      - OCTO_IDENTITY__KeyFilePath=/etc/octo-identity/IdentityServer4Auth.pfx
      - OCTO_IDENTITY__KEYFILEPASSWORD=mvf*vkm9ehe.hyr!KRA
      - OCTO_IDENTITY__AUTHORITYURL=https://octo-identity-services:5003
      - OCTO_IDENTITY__IdentityServerLicenseKey=eyJhbGciOiJQUzI1NiIsImtpZCI6IklkZW50aXR5U2VydmVyTGljZW5zZUtleS83Y2VhZGJiNzgxMzA0NjllODgwNjg5MTAyNTQxNGYxNiIsInR5cCI6ImxpY2Vuc2Urand0In0.eyJpc3MiOiJodHRwczovL2R1ZW5kZXNvZnR3YXJlLmNvbSIsImF1ZCI6IklkZW50aXR5U2VydmVyIiwiaWF0IjoxNzU2NDc5ODcxLCJleHAiOjE3ODgwMTU4NzEsImNvbXBhbnlfbmFtZSI6Ik1lc2htYWtlcnMgR21iSCIsImNvbnRhY3RfaW5mbyI6ImdlcmFsZC5sb2NobmVyQHNhbHpidXJnZGV2LmF0IiwiZWRpdGlvbiI6IkNvbW11bml0eSJ9.TNjfPOqI7s2q2w5wcogN2KydjZJ0Bq0C7myOq82SA-fW7fekbqqaaIOHFSEGbtQ_CDmCNhsaBJq29Y1YxMwvR5FzXuZb0G0typHroie9OT0YiMbe82C9J9xVTUTj7R_0Sa2wk-OpaTO9AWMF4ZNfZs3f8QD_jD3PTkKkjhKGJbGWubpRM2WxnEX6vicEkcnxrM3jFfg81dKAVviRy8HIAT9b7hQZlYbT2pVoM2lpqNsb1cDy0_dqMxPFaP0FhSVkG-sNDWy2fqv-SJHjHYx6BMeRkxzf2ycRF09uWFJJvc_ckQ7nqO5pRtpacWaQ-EU-ze4j5jnnEgdXaLuwZwNCWg
      - OCTO_IDENTITY__AutoMapperLicenseKey=eyJhbGciOiJSUzI1NiIsImtpZCI6Ikx1Y2t5UGVubnlTb2Z0d2FyZUxpY2Vuc2VLZXkvYmJiMTNhY2I1OTkwNGQ4OWI0Y2IxYzg1ZjA4OGNjZjkiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2x1Y2t5cGVubnlzb2Z0d2FyZS5jb20iLCJhdWQiOiJMdWNreVBlbm55U29mdHdhcmUiLCJleHAiOiIxNzg1MTk2ODAwIiwiaWF0IjoiMTc1MzcxMzU3MSIsImFjY291bnRfaWQiOiIwMTk4NTE3OTFmNzY3ZDEwOGMwYjNiYzhjODNlMmY5NSIsImN1c3RvbWVyX2lkIjoiY3RtXzAxazE4cWp4NTJtemtlbW1wcWszZmF5Mnl3Iiwic3ViX2lkIjoiLSIsImVkaXRpb24iOiIwIiwidHlwZSI6IjIifQ.qlbbn1_eEpLhfUIIaVMGHhiKT_FTgR7b9niUJAfZE6MA5jPLAdpzQFKhvAsMTAl8fB2tCXsrsN7lT_OSFSSsmZKY1nLwvQs5GgfyGfG0vGbWQBbQbml27ofnZcTbMVideLqOJ1uZtWkilFjQ5utvt2id4n7zegDSgXbL2uA8Fe7iE1uZdm7rMjx5nFBXSt3694FlljVQ0YcJwIhGM1J-JxoGPfsfhbpSMP3YHbWlRDv2Gt53mir5tSpYLb6ZelFkjz7a4j7Fp0kctbWMI2nPH-XIz3KbExGxRIQ3G4XJ-lHnf9mWrrgoOXmGWQihQPStfpsLIpDy7zqyLJmPbB1M4g
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:5003
      - ASPNETCORE_HTTPS_PORT=5003
      - ASPNETCORE_Kestrel__Certificates__Default__Password=Secret01
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/etc/octo-identity/localhost_cert.pfx
    ports:
      - "5003:5003"
    networks:
      - octo-internal
    volumes:
      - "./IdentityServer4Auth.pfx:/etc/octo-identity/IdentityServer4Auth.pfx"
      - "./localhost_cert.pfx:/etc/octo-identity/localhost_cert.pfx"
      - "./localhost_cert.pem:/etc/ssl/certs/localhost_cert.pem"
    links:
      - octo-rabbitmq
      - octo-mongo-0.mongo
      - octo-mongo-1.mongo
      - octo-mongo-2.mongo
      
  octo-asset-services:
    hostname: octo-asset-rep-services
    container_name: octo-asset-rep-services
    image: meshmakers/octo-mesh-asset-rep-services:${OCTO_VERSION}
    restart: always
    environment:
      - OCTO_SYSTEM__DATABASEUSERPASSWORD=${USER_PASSWORD}
      - OCTO_SYSTEM__ADMINUSERPASSWORD=${ADMIN_PASSWORD}
      - OCTO_SYSTEM__DATABASEHOST=octo-mongo-0.mongo:27017,octo-mongo-1.mongo:27017,octo-mongo-2.mongo:27017
      - OCTO_ASSETREPOSITORY__BROKERHOST=octo-rabbitmq
      - OCTO_ASSETREPOSITORY__BROKERUSER=${RABBITMQ_DEFAULT_USER}
      - OCTO_ASSETREPOSITORY__BROKERPASSWORD=${RABBITMQ_DEFAULT_PASS}
      - OCTO_ASSETREPOSITORY__AUTHORITY=https://octo-identity-services:5003
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:5001
      - ASPNETCORE_HTTPS_PORT=5001
      - ASPNETCORE_Kestrel__Certificates__Default__Password=Secret01
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/etc/octo-asset/localhost_cert.pfx
    ports:
      - "5001:5001"
    networks:
      - octo-internal
    volumes:
      - "./localhost_cert.pfx:/etc/octo-asset/localhost_cert.pfx"
      - "./localhost_cert.pem:/etc/ssl/certs/localhost_cert.pem"
    links:
      - octo-identity-services
      - octo-rabbitmq
      - octo-mongo-0.mongo
      - octo-mongo-1.mongo
      - octo-mongo-2.mongo
      
  octo-bot-services:
    hostname: octo-bot-services
    container_name: octo-bot-services
    image: meshmakers/octo-mesh-bot-services:${OCTO_VERSION}
    restart: always
    environment:
      - OCTO_SYSTEM__DATABASEUSERPASSWORD=${USER_PASSWORD}
      - OCTO_SYSTEM__ADMINUSERPASSWORD=${ADMIN_PASSWORD}
      - OCTO_SYSTEM__DATABASEHOST=octo-mongo-0.mongo:27017,octo-mongo-1.mongo:27017,octo-mongo-2.mongo:27017
      - OCTO_BOT__BROKERHOST=octo-rabbitmq
      - OCTO_BOT__BROKERUSER=${RABBITMQ_DEFAULT_USER}
      - OCTO_BOT__BROKERPASSWORD=${RABBITMQ_DEFAULT_PASS}
      - OCTO_BOT__AUTHORITYURL=https://octo-identity-services:5003
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:5009
      - ASPNETCORE_HTTPS_PORT=5009
      - ASPNETCORE_Kestrel__Certificates__Default__Password=Secret01
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/etc/octo-bot/localhost_cert.pfx
    ports:
      - "5009:5009"
    networks:
      - octo-internal
    volumes:
      - "./localhost_cert.pfx:/etc/octo-bot/localhost_cert.pfx"
      - "./localhost_cert.pem:/etc/ssl/certs/localhost_cert.pem"
    links:
      - octo-identity-services
      - octo-rabbitmq
      - octo-mongo-0.mongo
      - octo-mongo-1.mongo
      - octo-mongo-2.mongo
      
  octo-communication-controller-services:
    hostname: octo-communication-controller-services
    container_name: octo-communication-controller-services
    image: meshmakers/octo-mesh-communication-controller-services:${OCTO_VERSION}
    restart: always
    environment:
      - OCTO_SYSTEM__DATABASEUSERPASSWORD=${USER_PASSWORD}
      - OCTO_SYSTEM__ADMINUSERPASSWORD=${ADMIN_PASSWORD}
      - OCTO_SYSTEM__DATABASEHOST=octo-mongo-0.mongo:27017,octo-mongo-1.mongo:27017,octo-mongo-2.mongo:27017
      - OCTO_COMMUNICATIONCONTROLLER__BROKERHOST=octo-rabbitmq
      - OCTO_COMMUNICATIONCONTROLLER__BROKERUSER=${RABBITMQ_DEFAULT_USER}
      - OCTO_COMMUNICATIONCONTROLLER__BROKERPASSWORD=${RABBITMQ_DEFAULT_PASS}
      - OCTO_COMMUNICATIONCONTROLLER__AUTHORITY=https://octo-identity-services:5003
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:5015
      - ASPNETCORE_HTTPS_PORT=5015
      - ASPNETCORE_Kestrel__Certificates__Default__Password=Secret01
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/etc/octo-com-ctrl/localhost_cert.pfx
    ports:
      - "5015:5015"
    networks:
      - octo-internal
    volumes:
      - "./localhost_cert.pfx:/etc/octo-com-ctrl/localhost_cert.pfx"
      - "./localhost_cert.pem:/etc/ssl/certs/localhost_cert.pem"
    links:
      - octo-identity-services
      - octo-rabbitmq
      - octo-mongo-0.mongo
      - octo-mongo-1.mongo
      - octo-mongo-2.mongo
      
  octo-admin-panel:
    hostname: octo-admin-panel
    container_name: octo-admin-panel
    image: meshmakers/octo-mesh-adminpanel:${OCTO_VERSION}
    restart: always
    environment:
      - OCTO_SYSTEM__DATABASEUSERPASSWORD=${USER_PASSWORD}
      - OCTO_SYSTEM__ADMINUSERPASSWORD=${ADMIN_PASSWORD}
      - OCTO_SYSTEM__DATABASEHOST=octo-mongo-0.mongo:27017,octo-mongo-1.mongo:27017,octo-mongo-2.mongo:27017
      - OCTO_ADMINPANEL__AUTHORITYURL=https://octo-identity-services:5003
      - OCTO_ADMINPANEL__BROKERHOST=octo-rabbitmq
      - OCTO_ADMINPANEL__BROKERUSER=${RABBITMQ_DEFAULT_USER}
      - OCTO_ADMINPANEL__BROKERPASSWORD=${RABBITMQ_DEFAULT_PASS}
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:5005
      - ASPNETCORE_HTTPS_PORT=5005
      - ASPNETCORE_Kestrel__Certificates__Default__Password=Secret01
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/etc/octo-admin-panel/localhost_cert.pfx
    ports:
      - "5005:5005"
    networks:
      - octo-internal
    volumes:
      - "./localhost_cert.pfx:/etc/octo-admin-panel/localhost_cert.pfx"
      - "./localhost_cert.pem:/etc/ssl/certs/localhost_cert.pem"
    links:
      - octo-identity-services
      - octo-rabbitmq
      - octo-mongo-0.mongo
      - octo-mongo-1.mongo
      - octo-mongo-2.mongo
